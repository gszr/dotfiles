#!/bin/bash

function usage {
  cat << EOF
Git Utilities

usage: $0 [options] command

Options:
  -d  base directory
  -l  max directory level

Commands:
  list  list Git repositories
  list-dirty  list dirty Git repositories
EOF
  exit 1
}

BASE_DIR=$PWD
MAX_LEVEL=1

function parse_args {
  while getopts ":d:l:h" option; do
    case $option in
      d)
        BASE_DIR=$OPTARG
        ;;
      l)
        MAX_LEVEL=$OPTARG
        ;;
      ?)
        usage
        ;;
    esac
  done
  idx=$((OPTIND-1))
}

function list_git_repos {
  local dir=$BASE_DIR
  echo "Scanning Git repositories under $dir"
  for subdir in $(find $dir -type d -maxdepth $MAX_LEVEL); do
    if [[ -d $subdir/.git ]]; then
      echo "-> $subdir"
    fi
  done
}

function list_dirty_git_repos {
  local dir=$BASE_DIR
  echo "Scanning dirty Git repositories under $dir"
  for subdir in $(find $dir -type d -maxdepth $MAX_LEVEL); do
    if [[ -d $subdir/.git ]]; then
      pushd $subdir &> /dev/null
        if [[ -n $(git status | grep -i 'not staged\|untracked') ]]; then
          echo "-> $subdir"
        fi
      popd &> /dev/null
    fi
  done
}

parse_args $@
shift $idx

case $1 in
  list)
    list_git_repos
    ;;
  list-dirty)
    list_dirty_git_repos
    ;;
  *)
    echo "Unknown command"
    usage
    ;;
esac
